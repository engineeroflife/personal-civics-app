<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0C1D3F" />
  <title>Civics Practice</title>

  <style>
    /* Colorful logo */
.brand{
  display:flex;
  align-items:center;
  gap:14px;
}
.brand .logo{
  width:auto;
  height:88px;
  flex:0 0 88px;
  object-fit: contain;
  display: block;
  filter: drop-shadow(0 6px 12px rgba(0,0,0,.12));
}
.brand .title-wrap{
  display:flex;
  flex-direction:column;
  line-height:1.05;
}
.brand .app-title{
  margin:0;
}
.brand .app-subtitle{
  margin:4px 0 0 0;
  color: var(--muted);
  font-weight: 500;
  font-size: 14px;
}
    :root{
      --navy:#0C1D3F;
      --red:#BF1E2E;
      --bg:#ffffff;
      --panel:#f6f7f9;
      --ink:#000000;
      --muted:#5b6472;
      --stroke:rgba(0,0,0,.10);
      --shadow:0 10px 26px rgba(0,0,0,.10);
      --radius:18px;
      --max:920px;
      --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:var(--bg);
      color:var(--ink);
      -webkit-text-size-adjust: 100%;
      overscroll-behavior: none;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.92);
      backdrop-filter:saturate(180%) blur(14px);
      border-bottom:1px solid var(--stroke);
      padding:14px 16px;
      padding-top: calc(14px + env(safe-area-inset-top));
    }
    .wrap{max-width:var(--max); margin:0 auto;}
    .brandRow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .brandLeft{display:flex; align-items:center; gap:12px; min-width:260px;}
    .flag{display:flex; align-items:center; gap:10px;}
    .flag .bar{height:10px; border-radius:999px;}
    .flag .navy{width:52px; background:var(--navy);}
    .flag .red{width:28px; background:var(--red);}
    .titles .title{font-weight:800; letter-spacing:.2px; font-size:1.2rem;}
    .titles .sub{color:var(--muted); font-size:.92rem; margin-top:2px;}
    .controls{
      display:flex; flex-wrap:wrap;
      gap:10px; align-items:center; justify-content:flex-end;
      width:100%;
    }
    select, .chipBtn{
      height:38px;
      border:1px solid var(--stroke);
      border-radius:12px;
      background:#fff;
      padding:0 12px;
      font-size:.95rem;
      color:var(--ink);
    }
    .toggle{
      display:flex; align-items:center; gap:8px;
      padding:0 10px;
      height:38px;
      border:1px solid var(--stroke);
      border-radius:12px;
      background:#fff;
      font-size:.95rem;
    }
    .toggle input{transform:scale(1.1)}
    main{
      padding:18px 16px;
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
    }
    .view{max-width:var(--max); margin:0 auto;}
    .hidden{display:none !important;}

    .card{
      background:#fff;
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .cardTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:12px;
      border-bottom:1px solid rgba(0,0,0,.06);
      margin-bottom:14px;
    }
    .meta{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .pill{
      display:inline-flex; align-items:center;
      height:26px;
      padding:0 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(0,0,0,.03);
      color:var(--navy);
      font-size:.78rem;
      font-weight:700;
      letter-spacing:.9px;
    }
    .pill.star{color:#000;}

    /* üí° Practice badge */
    .pill.practice{
      background: rgba(255, 204, 0, 0.18);
      border-color: rgba(255, 204, 0, 0.45);
      color: #8a6a00;
    }

    .dot{color:rgba(0,0,0,.45)}
    .muted{color:var(--muted)}
    .questionText{
      font-size:1.35rem;
      font-weight:800;
      line-height:1.25;
      margin:0;
    }
    .answers{
      margin-top:14px;
      padding:12px 14px;
      border-radius:14px;
      background:var(--panel);
      border:1px solid rgba(0,0,0,.06);
      line-height:1.55;
    }
    .answers .aLine{display:flex; gap:10px; align-items:flex-start; margin:6px 0;}
    .answers .bullet{
      width:7px; height:7px;
      background:var(--red);
      border-radius:999px;
      margin-top:9px;
      flex:0 0 auto;
    }
    .btnRow{
      display:flex;
      gap:10px;
      margin-top:14px;
      flex-wrap:wrap;
    }
    button{
      border:1px solid var(--stroke);
      background:#fff;
      color:#000;
      padding:12px 12px;
      border-radius:14px;
      font-size:1rem;
      cursor:pointer;
      flex:1 1 140px;
      min-height:44px;
    }
    button.primary{
      background:var(--navy);
      color:#fff;
      border-color:rgba(0,0,0,.0);
    }
    button.ghost{background:#fff; color:#000;}
    button:disabled{opacity:.5; cursor:not-allowed;}

    .footerRow{
      margin-top:12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .notice{
      margin-top:14px;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(191,30,46,.25);
      background:rgba(191,30,46,.06);
      color:#000;
    }
    code{background:rgba(0,0,0,.06); padding:2px 6px; border-radius:8px;}

    .panel{
      padding:14px;
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      background:var(--panel);
      margin-bottom:14px;
    }
    .panelRow{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .kpis{display:flex; gap:12px; flex-wrap:wrap;}
    .kpi{font-size:.95rem;}
    .result{
      margin-top:14px;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
    }
    .small{font-size:.92rem;}

    /* ===== Card flash animations ===== */
    @keyframes flashGreen { 0%{background-color:#2ecc71;} 100%{background-color:#ffffff;} }
    @keyframes flashRed   { 0%{background-color:#e74c3c;} 100%{background-color:#ffffff;} }
    @keyframes flashFlip  { 0%{background-color:rgba(12,29,63,.12);} 100%{background-color:#ffffff;} }
    .flash-correct { animation: flashGreen 2s ease-out; }
    .flash-wrong   { animation: flashRed 2s ease-out; }
    .flash-flip    { animation: flashFlip 300ms ease-out; }

    /* ===== Full-screen tint overlay ===== */
    #screenFlash{
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0;
      z-index: 9999;
    }
    @keyframes screenGreen { 0%{opacity:.22;} 100%{opacity:0;} }
    @keyframes screenRed   { 0%{opacity:.22;} 100%{opacity:0;} }
    #screenFlash.green { background:#2ecc71; animation: screenGreen 2s ease-out; }
    #screenFlash.red   { background:#e74c3c; animation: screenRed 2s ease-out; }

    /* ===== iPhone portrait fit ===== */
    html, body { height: 100%; max-width: 100%; overflow-x: hidden; }

    @media (max-width: 520px) {
      .brandRow { flex-direction: column; align-items: flex-start; }
      .controls { justify-content: flex-start; }
      .btnRow button { flex: 1 1 100%; }
      .questionText { font-size: 1.18rem; }
      .card { padding: 14px; }
    }
    .progress {
  display: flex;
  flex-direction: column;   /* STACKS them */
  gap: 6px;                 /* space between lines */
}
.logo {
  display: block !important;
  visibility: visible !important;
  height: 96px;
  width: auto;
}

  </style>
</head>

<body>
  <div id="screenFlash" aria-hidden="true"></div>

  <header>
    <div class="wrap brandRow">
      <div class="brandLeft">
        <div class="flag" aria-hidden="true">
          <span class="bar navy"></span>
          <span class="bar red"></span>
        </div>
       <div class="brand">

  <div class="header">
<img src="assets/bea.png" class="logo" alt="Bea the Otter">


  <div class="title-block">
    <h1 class="app-title">Civics Practice</h1>
    <div class="app-subtitle">
      with Bea the Otter 
    </div>
  </div>
</div>

  </div>
</div>
      </div>

      <div class="controls">
        <select id="mode">
          <option value="cards">Flashcards</option>
          <option value="interview">Interview Mode</option>
          <option value="practice">Practice List</option>
        </select>

        <label class="toggle">
          <input type="checkbox" id="starOnly" />
          <span>‚≠ê Only</span>
        </label>

        <label class="toggle">
          <input type="checkbox" id="shuffleMode" />
          <span>üîÑ Shuffle</span>
        </label>

        <select id="ttsSpeed" title="Text-to-speech speed">
          <option value="normal">TTS Normal</option>
          <option value="slow">TTS Slow</option>
        </select>

        <select id="ttsVoice" title="Voice">
          <option value="">Voice (Auto)</option>
        </select>

        <button class="chipBtn" id="reloadBtn" title="Reload questions">Reload</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Flashcards View -->
    <section id="cardsView" class="view">
      <div class="card" id="questionCard">
        <div class="cardTop">
          <div class="meta">
            <span id="cardLabel" class="pill">QUESTION</span>
            <span class="dot">‚Ä¢</span>
            <span id="cardNum" class="muted">#‚Äî</span>
            <span id="cardStar" class="pill star hidden">‚≠ê</span>
            <span id="practiceBadge" class="pill practice hidden">üí° PRACTICE</span>
          </div>
          <button class="ghost" id="flipBtn">Show Answer</button>
        </div>

        <p id="qText" class="questionText">Loading questions‚Ä¶</p>

        <div id="aBox" class="answers hidden"></div>

        <div class="btnRow">
          <button id="prevBtn">‚óÄ Prev</button>
          <button id="speakQBtn">üîä Speak Q</button>
          <button id="speakABtn">üîä Speak A</button>
          <button id="addPracticeBtn">üí° Needs Practice</button>
          <button id="nextBtn">Next ‚ñ∂</button>
        </div>

        <div class="footerRow">
          <div class="muted small" id="progressText"></div>
          <div class="muted small" id="sourceText"></div>
        </div>

        <div id="loadNotice" class="notice hidden"></div>
      </div>
    </section>

    <!-- Interview View -->
    <section id="interviewView" class="view hidden">
      <div class="panel">
        <div class="panelRow">
          <div class="kpis">
            <div class="kpi">Asked: <b id="asked">0</b>/20</div>
            <div class="kpi">Correct: <b id="correct">0</b></div>
            <div class="kpi">Wrong: <b id="wrong">0</b></div>
          </div>
          <div class="kpis">
            <button id="startInterviewBtn" class="primary">Start</button>
            <button id="reviewMissedBtn" class="ghost hidden">Review Missed</button>
            <button id="resetInterviewBtn" class="ghost">Reset</button>
          </div>
        </div>
      </div>

      <div class="card" id="interviewCard">
        <div class="cardTop">
          <div class="meta">
            <span class="pill">QUESTION</span>
            <span class="dot">‚Ä¢</span>
            <span id="iNum" class="muted">#‚Äî</span>
          </div>
          <button class="ghost" id="iSpeakBtn">üîä Speak</button>
        </div>

        <p id="iQuestion" class="questionText">Press Start to begin.</p>

        <details class="answers" id="iAnswersWrap">
          <summary>Show acceptable answers</summary>
          <div id="iAnswers" style="margin-top:10px;"></div>
        </details>

        <div class="btnRow">
          <button id="markWrongBtn">Incorrect</button>
          <button id="markCorrectBtn" class="primary">Correct</button>
        </div>

        <div id="result" class="result hidden"></div>
      </div>
    </section>

    <!-- Practice List View -->
    <section id="practiceView" class="view hidden">
      <div class="panel">
        <div class="panelRow">
          <div class="kpis">
            <div class="kpi">Saved: <b id="practiceCount">0</b></div>
          </div>
          <div class="kpis">
            <button id="startPracticeBtn" class="primary">Start Practice</button>
            <button id="clearPracticeBtn" class="ghost">Clear</button>
          </div>
        </div>
      </div>

      <div class="card">
        <p class="questionText" style="margin-bottom:10px;">Your Practice List</p>
        <div id="practiceList" class="answers">Loading‚Ä¶</div>
      </div>
    </section>
  </main>

  <script>
    // ===== Helpers: flash + lock + screen tint + vibration =====
    function lockButtons(btns, ms) {
      btns.forEach(b => { if (b) b.disabled = true; });
      setTimeout(() => btns.forEach(b => { if (b) b.disabled = false; }), ms);
    }

    function flashCard(cardEl, type) {
      if (!cardEl) return 0;
      cardEl.classList.remove('flash-correct', 'flash-wrong', 'flash-flip');
      void cardEl.offsetWidth;
      cardEl.classList.add(type);
      const ms = (type === 'flash-flip') ? 350 : 2000;
      setTimeout(() => cardEl.classList.remove(type), ms);
      return ms;
    }

    function flashScreen(isCorrect) {
      const el = document.getElementById('screenFlash');
      if (!el) return;
      el.classList.remove('green', 'red');
      void el.offsetWidth;
      el.classList.add(isCorrect ? 'green' : 'red');
      setTimeout(() => el.classList.remove('green', 'red'), 2000);
    }

    function vibrateWrong() {
      if (navigator.vibrate) navigator.vibrate(200);
    }

    // ===== Practice List storage (FIXES practiceIds not defined) =====
    const PRACTICE_KEY = "civics_practice_ids_v1";
    let practiceIds = new Set();

    function loadPracticeIds() {
      try {
        const raw = localStorage.getItem(PRACTICE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        practiceIds = new Set(Array.isArray(arr) ? arr : []);
      } catch {
        practiceIds = new Set();
      }
    }
    function savePracticeIds() {
      localStorage.setItem(PRACTICE_KEY, JSON.stringify([...practiceIds]));
    }
    function getPracticeItems() {
      return allItems.filter(q => practiceIds.has(q.id));
    }

    // ---------- State ----------
    let payloadSource = "";
    let allItems = [];
    let items = [];
    let idx = 0;
    let showAnswer = false;

    // Interview state
    let interviewQueue = [];
    let interviewIndex = 0;
    let asked = 0, correct = 0, wrong = 0;
    let missed = [];

    // ---------- Elements ----------
    const modeEl = document.getElementById('mode');
    const starOnlyEl = document.getElementById('starOnly');
    const shuffleModeEl = document.getElementById('shuffleMode');
    const ttsSpeedEl = document.getElementById('ttsSpeed');
    const reloadBtn = document.getElementById('reloadBtn');

    const cardsView = document.getElementById('cardsView');
    const interviewView = document.getElementById('interviewView');
    const practiceView = document.getElementById('practiceView');

    const questionCard = document.getElementById('questionCard');
    const interviewCard = document.getElementById('interviewCard');

    const cardLabel = document.getElementById('cardLabel');
    const cardNum = document.getElementById('cardNum');
    const cardStar = document.getElementById('cardStar');
    const practiceBadge = document.getElementById('practiceBadge');

    const qText = document.getElementById('qText');
    const aBox = document.getElementById('aBox');
    const flipBtn = document.getElementById('flipBtn');

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const speakQBtn = document.getElementById('speakQBtn');
    const speakABtn = document.getElementById('speakABtn');
    const addPracticeBtn = document.getElementById('addPracticeBtn');

    const progressText = document.getElementById('progressText');
    const sourceText = document.getElementById('sourceText');
    const loadNotice = document.getElementById('loadNotice');

    const askedEl = document.getElementById('asked');
    const correctEl = document.getElementById('correct');
    const wrongEl = document.getElementById('wrong');

    const startInterviewBtn = document.getElementById('startInterviewBtn');
    const reviewMissedBtn = document.getElementById('reviewMissedBtn');
    const resetInterviewBtn = document.getElementById('resetInterviewBtn');
    const iNum = document.getElementById('iNum');
    const iQuestion = document.getElementById('iQuestion');
    const iSpeakBtn = document.getElementById('iSpeakBtn');
    const iAnswersWrap = document.getElementById('iAnswersWrap');
    const iAnswers = document.getElementById('iAnswers');
    const markWrongBtn = document.getElementById('markWrongBtn');
    const markCorrectBtn = document.getElementById('markCorrectBtn');
    const resultBox = document.getElementById('result');

    const practiceCount = document.getElementById('practiceCount');
    const practiceList = document.getElementById('practiceList');
    const startPracticeBtn = document.getElementById('startPracticeBtn');
    const clearPracticeBtn = document.getElementById('clearPracticeBtn');

    // ---------- Helpers ----------
    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[m]));
    }

    function renderPracticeList() {
      const list = getPracticeItems();
      practiceCount.textContent = String(list.length);

      if (!list.length) {
        practiceList.innerHTML = `<div class="muted">No saved questions yet. Use üí° Needs Practice or mark Incorrect in Interview Mode.</div>`;
        return;
      }

      practiceList.innerHTML = list.map(q => `
        <div style="padding:10px 0; border-bottom:1px solid rgba(0,0,0,.06);">
          <div style="font-weight:800;">#${q.id} ‚Äî ${escapeHtml(q.question)}</div>
          <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;">
            <button data-open="${q.id}" class="ghost" style="flex:0 0 auto;">Open</button>
            <button data-remove="${q.id}" style="flex:0 0 auto;">Remove</button>
          </div>
        </div>
      `).join("");

      practiceList.querySelectorAll('[data-open]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = Number(btn.getAttribute('data-open'));
          const pos = items.findIndex(x => x.id === id);
          if (pos >= 0) {
            idx = pos;
            showAnswer = false;
            setMode("cards");
            renderCard();
            window.scrollTo({ top: 0, behavior: "smooth" });
          }
        });
      });

      practiceList.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = Number(btn.getAttribute('data-remove'));
          practiceIds.delete(id);
          savePracticeIds();
          renderPracticeList();
          renderCard();
        });
      });
    }

    function applyFilter() {
      const base = starOnlyEl.checked ? allItems.filter(x => !!x.starred) : [...allItems];
      items = shuffleModeEl.checked ? shuffleArray(base) : base;

      if (!items.length) {
        qText.textContent = "No questions found for this filter.";
        aBox.classList.add('hidden');
        progressText.textContent = "";
        sourceText.textContent = "";
        return;
      }
      idx = 0;
      showAnswer = false;
      renderCard();
    }

    function renderCard() {
      if (!items.length) return;
      const it = items[idx];

      cardNum.textContent = "#" + it.id;
      cardStar.classList.toggle('hidden', !it.starred);

      // show badge only if saved for practice
      practiceBadge.classList.toggle('hidden', !practiceIds.has(it.id));

      qText.textContent = it.question;

      aBox.innerHTML = it.answers.map(a => `
        <div class="aLine">
          <span class="bullet"></span>
          <div>${escapeHtml(a)}</div>
        </div>`).join("");

      aBox.classList.toggle('hidden', !showAnswer);
      flipBtn.textContent = showAnswer ? "Hide Answer" : "Show Answer";
      cardLabel.textContent = showAnswer ? "ANSWER" : "QUESTION";

      progressText.textContent = `Card ${idx + 1} of ${items.length}`;
      sourceText.textContent = payloadSource ? `Source: ${payloadSource}` : "";
      prevBtn.disabled = (idx === 0);
      nextBtn.disabled = (idx === items.length - 1);
    }

    function ttsRate() {
      return ttsSpeedEl.value === "slow" ? 0.80 : 0.95;
    }

    function speak(text) {
      if (!text) return;
      if (!window.speechSynthesis) return alert("Text-to-Speech is not available in this browser.");
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      u.rate = ttsRate();
      speechSynthesis.speak(u);
    }

    // ---------- Data Load ----------
    async function loadQuestions() {
      loadNotice.classList.add('hidden');
      qText.textContent = "Loading questions‚Ä¶";
      aBox.classList.add('hidden');

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 8000);

      try {
        const res = await fetch("data/civics_128_2025.json", {
          cache: "no-store",
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!res.ok) throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);

        const json = await res.json();
        if (!json.items || !Array.isArray(json.items)) {
          throw new Error("JSON format error: expected { items: [...] }");
        }

        payloadSource = json.source || "";
        allItems = json.items;

        applyFilter();
        renderPracticeList();

      } catch (err) {
        clearTimeout(timeoutId);
        console.error(err);

        loadNotice.classList.remove('hidden');
        loadNotice.innerHTML = `
          <b>Questions file not found, blocked, or too slow.</b><br><br>
          Expected path:<br>
          <code>data/civics_128_2025.json</code><br><br>
          Error:<br>
          <code>${escapeHtml(err.name + ": " + err.message)}</code>
        `;
        qText.textContent = "Questions not loaded.";
        progressText.textContent = "";
        sourceText.textContent = "";
      }
    }

    // ---------- Flashcards Events ----------
    flipBtn.addEventListener('click', () => {
      flashCard(questionCard, 'flash-flip');
      showAnswer = !showAnswer;
      renderCard();
    });

    prevBtn.addEventListener('click', () => {
      if (idx > 0) { idx--; showAnswer = false; renderCard(); }
    });

    nextBtn.addEventListener('click', () => {
      if (idx < items.length - 1) { idx++; showAnswer = false; renderCard(); }
    });

    speakQBtn.addEventListener('click', () => {
      if (!items.length) return;
      speak("Question. " + items[idx].question);
    });

    speakABtn.addEventListener('click', () => {
      if (!items.length) return;
      speak("Answer. " + items[idx].answers.join(". "));
    });

    // Save current flashcard into practice list
    addPracticeBtn.addEventListener('click', () => {
      if (!items.length) return;
      const id = items[idx].id;
      practiceIds.add(id);
      savePracticeIds();
      flashScreen(true);
      renderCard();         // shows badge immediately
      renderPracticeList(); // updates Practice view
    });

    // ---------- Interview ----------
    function resetInterviewUI() {
      askedEl.textContent = asked;
      correctEl.textContent = correct;
      wrongEl.textContent = wrong;
    }

    function interviewStart(queue) {
      interviewQueue = queue.slice(0, 20);
      interviewIndex = 0;
      asked = 0; correct = 0; wrong = 0;
      missed = [];
      resultBox.classList.add('hidden');
      reviewMissedBtn.classList.add('hidden');
      iAnswersWrap.open = false;
      showInterviewQuestion();
      resetInterviewUI();
    }

    function showInterviewQuestion() {
      const it = interviewQueue[interviewIndex];
      if (!it) {
        finishInterview();
        return;
      }
      iNum.textContent = "#" + it.id;
      iQuestion.textContent = it.question;
      iAnswers.innerHTML = it.answers.map(a =>
        `<div class="aLine"><span class="bullet"></span><div>${escapeHtml(a)}</div></div>`
      ).join("");
      iAnswersWrap.open = false;
    }

    function finishInterview() {
      const passed = correct >= 12;
      resultBox.classList.remove('hidden');
      resultBox.innerHTML = `
        <b style="font-size:1.2rem;">${passed ? "PASS ‚úÖ" : "NOT YET ‚ùóÔ∏è"}</b><br>
        <div style="margin-top:6px;">Score: <b>${correct}</b>/20 (need 12 correct)</div>
        <div class="muted small" style="margin-top:6px;">Manual scoring ‚Ä¢ Review missed to improve</div>
      `;
      if (missed.length) {
        reviewMissedBtn.classList.remove('hidden');
        reviewMissedBtn.textContent = `Review Missed (${missed.length})`;
      }
    }

    startInterviewBtn.addEventListener('click', () => {
      if (!items.length) return alert("Load questions first (Flashcards view).");
      const pool = items.slice().sort(() => Math.random() - 0.5);
      interviewStart(pool);
    });

    resetInterviewBtn.addEventListener('click', () => {
      interviewQueue = [];
      interviewIndex = 0;
      asked = 0; correct = 0; wrong = 0; missed = [];
      iNum.textContent = "#‚Äî";
      iQuestion.textContent = "Press Start to begin.";
      iAnswers.innerHTML = "";
      iAnswersWrap.open = false;
      resultBox.classList.add('hidden');
      reviewMissedBtn.classList.add('hidden');
      resetInterviewUI();
    });

    reviewMissedBtn.addEventListener('click', () => {
      if (!missed.length) return;
      const pool = missed.slice().sort(() => Math.random() - 0.5);
      interviewStart(pool);
    });

    iSpeakBtn.addEventListener('click', () => {
      const it = interviewQueue[interviewIndex];
      if (!it) return;
      speak("Question. " + it.question);
    });

    markCorrectBtn.addEventListener('click', () => {
      const it = interviewQueue[interviewIndex];
      if (!it) return;

      flashScreen(true);
      const ms = flashCard(interviewCard, 'flash-correct');
      lockButtons([markCorrectBtn, markWrongBtn, startInterviewBtn, resetInterviewBtn, reviewMissedBtn], ms);

      correct++; asked++;
      interviewIndex++;
      resetInterviewUI();
      setTimeout(showInterviewQuestion, ms);
    });

    // Wrong = vibrate + auto-add to practice list
    markWrongBtn.addEventListener('click', () => {
      const it = interviewQueue[interviewIndex];
      if (!it) return;

      vibrateWrong();
      flashScreen(false);
      const ms = flashCard(interviewCard, 'flash-wrong');
      lockButtons([markCorrectBtn, markWrongBtn, startInterviewBtn, resetInterviewBtn, reviewMissedBtn], ms);

      wrong++; asked++;
      if (!missed.find(x => x.id === it.id)) missed.push(it);

      // ‚úÖ auto-save wrong answers to practice list
      practiceIds.add(it.id);
      savePracticeIds();
      renderPracticeList();
      renderCard();

      interviewIndex++;
      resetInterviewUI();
      setTimeout(showInterviewQuestion, ms);
    });

    // ---------- Practice View buttons ----------
    startPracticeBtn.addEventListener('click', () => {
      const list = getPracticeItems();
      if (!list.length) return alert("Your Practice List is empty.");
      items = list.slice();
      idx = 0;
      showAnswer = false;
      setMode("cards");
      renderCard();
    });

    clearPracticeBtn.addEventListener('click', () => {
      if (!practiceIds.size) return;
      practiceIds.clear();
      savePracticeIds();
      renderPracticeList();
      renderCard();
    });

    // ---------- Mode switching ----------
    function setMode(m) {
      const isCards = (m === "cards");
      const isInterview = (m === "interview");
      const isPractice = (m === "practice");

      cardsView.classList.toggle('hidden', !isCards);
      interviewView.classList.toggle('hidden', !isInterview);
      practiceView.classList.toggle('hidden', !isPractice);

      if (isPractice) renderPracticeList();
    }

    modeEl.addEventListener('change', () => setMode(modeEl.value));
    starOnlyEl.addEventListener('change', () => applyFilter());
    shuffleModeEl.addEventListener('change', () => applyFilter());
    reloadBtn.addEventListener('click', () => loadQuestions());

    // Start
    setMode("cards");
    loadPracticeIds();   // ‚úÖ must run before renderCard uses practiceIds
    loadQuestions();
  </script>
</body>
</html>
